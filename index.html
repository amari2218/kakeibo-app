<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§¾ æ”¯å‡ºç®¡ç†</title>
  <style>
    @font-face{
      font-family: "MyFont";
      src: url("./fonts/MyFont.otf") format("opentype");
      font-display: swap;
    }
    :root{
      --bg: #f3f5f8;
      --bg2:#eef2f7;
      --card:#ffffff;
      --ink:#1f2a37;
      --muted:#607086;
      --line:#dbe3ef;

      --accent:#78b6ff;
      --accentSoft:#e7f2ff;

      /* è§’ä¸¸ãƒ«ãƒ¼ãƒ« */
      --r-card: 20px;   /* ã‚«ãƒ¼ãƒ‰ */
      --r-input: 14px;  /* å…¥åŠ›/ãƒœã‚¿ãƒ³ */
      --r-pill: 999px;  /* ãƒ”ãƒ« */

      --shadow: 0 10px 28px rgba(31,42,55,.08);

      --font: "MyFont", ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--ink);
      background:
        radial-gradient(900px 600px at 10% 0%, #ffffff 0%, transparent 60%),
        radial-gradient(900px 600px at 100% 20%, #d9ebff 0%, transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 14px 70px;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 2px 8px;
    }
    .badge{
      width:42px; height:42px; border-radius: 16px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--accent), #cfe6ff);
      color:#0b3a66;
      border: 1px solid #cfe2ff;
      box-shadow: var(--shadow);
      font-size: 20px;
    }
    .headText .title{
      font-weight: 900;
      letter-spacing: .02em;
      font-size: 16px;
      line-height: 1.2;
    }
    .headText .sub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      margin-top: 3px;
    }

    /* ===== Tabs (sticky) ===== */
    .tabs{
      position: sticky;
      top: 0;
      z-index: 5;
      margin: 10px 0 12px;
      padding: 10px;
      border-radius: var(--r-card);
      background: rgba(255,255,255,.75);
      border: 1px solid var(--line);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 22px rgba(31,42,55,.06);
      display:flex;
      gap:10px;
    }
    .tabBtn{
      flex:1;
      border: 1px solid #d9e3f1;
      border-radius: var(--r-pill);
      background: #fff;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;

      /* 1è¡Œç›®=çµµæ–‡å­— / 2è¡Œç›®=ãƒ©ãƒ™ãƒ«ï¼ˆæ ã‚µã‚¤ã‚ºã¯ãã®ã¾ã¾ï¼‰ */
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      line-height: 1.05;
      text-align:center;
    }
    .tabEmoji{
      font-size: 18px;
      line-height: 1;
    }
    .tabLabel{
      font-size: 16px;
      font-weight: 900;
      white-space: nowrap;
    }
    @media (max-width: 420px){
      .tabBtn{ padding: 9px 10px; gap: 5px; }
      .tabEmoji{ font-size: 16px; }
      .tabLabel{ font-size: 14px; }
    }
    .tabBtn[aria-selected="true"]{
      border-color: #a8d2ff;
      background: linear-gradient(135deg, var(--accentSoft), #ffffff);
      box-shadow: inset 0 0 0 3px rgba(120,182,255,.35);
    }


    /* ===== Cards ===== */
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r-card);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 12px;
    }

    .bigSum{
      cursor: pointer;
      user-select:none;
      background: linear-gradient(135deg, #ffffff, #f3f9ff);
      border: 1px solid #cfe2ff;
    }
    .bigSum .month{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .02em;
    }
    .bigSum .sum{
      font-size: 26px;
      font-weight: 900;
      margin-top: 6px;
      color:#0b3a66;
    }
    .bigSum .hint{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
    }

    /* ===== Font panel ===== */
    details.fontBox{
      border: 1px solid #cfe2ff;
      background: #f7fbff;
      border-radius: var(--r-card);
      padding: 10px 12px;
    }
    details.fontBox summary{
      cursor:pointer;
      font-weight: 900;
      list-style:none;
    }
    details.fontBox summary::-webkit-details-marker{display:none}
    .fontRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .fontRow > div{flex:1; min-width: 220px;}
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input, select, textarea, button{
      font: inherit;
      border-radius: var(--r-input);
      border: 1px solid #d9e3f1;
      background: #fff;
      padding: 10px 12px;
      outline: none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: #a8d2ff;
      box-shadow: 0 0 0 4px rgba(120,182,255,.16);
    }
    .btn{
      border:none;
      background: linear-gradient(135deg, var(--accent), #b7dcff);
      color: #073357;
      font-weight: 900;
      cursor:pointer;
      padding: 11px 14px;
      border-radius: var(--r-input);
    }
    .btnGhost{
      background: #f7fbff;
      border: 1px dashed #b9d7ff;
      color: #0b3a66;
      cursor:pointer;
      padding: 11px 14px;
      border-radius: var(--r-input);
    }
    .btnDanger{
      background:#fff4f7;
      border:1px solid #ffd1df;
      color:#7a0b2e;
      cursor:pointer;
      padding: 11px 14px;
      border-radius: var(--r-input);
      font-weight:900;
    }

    .twoCol{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .twoCol > *{flex:1; min-width: 160px;}

    /* ===== Lists ===== */
    .list{
      margin-top: 8px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .rowItem{
      border: 1px solid #e6edf7;
      background: #fff;
      border-radius: var(--r-card);
      padding: 10px 10px;
      display:flex;
      align-items:flex-start;
      gap:10px;
          width:100%;
    }
    .tapArea{
      flex:1;
      cursor:pointer;
      user-select:none;
      padding: 2px 0;
          min-width:0;
    }
    .leftIcon{
      width: 40px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items:center;
      padding-top: 2px;
      flex-shrink:0;
    }
    .catEmoji{
      width: 34px; height: 34px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: #f7fbff;
      border: 1px solid #cfe2ff;
      font-size: 18px;
    }
    .editBtn, .trashBtn{
      width: 34px; height: 34px;
      border-radius: 14px;
      display:grid; place-items:center;
      background:#ffffff;
      border: 1px solid #d9e3f1;
      cursor:pointer;
      font-size: 16px;
    }
    .trashBtn{
      background:#fff4f7;
      border-color:#ffd1df;
    }

    .line1{
      display:flex;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }
        .mainRowLeft{
      display:flex;
      gap:10px;
      align-items:baseline;
      min-width:0;
      flex:1;
    }
.memo{
font-weight: 900;
      font-size: 13px;
      line-height: 1.35;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      flex:1;
      min-width:0;
    }
    .amount{
font-weight: 900;
      font-size: 14px;
      color:#0b3a66;
      white-space: nowrap;
            margin-left:auto;
      flex-shrink:0;
    }
    .line2{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    .dateMini{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      margin-right: 10px;
      white-space: nowrap;
    }

    /* ===== Ledger header ===== */
    .ledgerHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .monthNav{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 11px;
      border-radius: var(--r-pill);
      border: 1px solid var(--line);
      background: #fbfdff;
      font-size: 12px;
      color: #22415c;
    }
    .miniIconBtn{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 1px solid #d9e3f1;
      background: #fff;
      cursor:pointer;
      font-size: 16px;
      display:grid;
      place-items:center;
    }
    .miniIconBtn.on{
      border-color:#ffd1df;
      background:#fff4f7;
    }

    /* ===== Legend popover ===== */
    .legendBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--r-card);
      border: 1px solid #cfe2ff;
      background: #f7fbff;
      color:#2e4d68;
      font-size: 12px;
      line-height: 1.65;
      display:none;
    }
    .legendBox.show{display:block}

    /* ===== Modal overlay (detail + confirm) ===== */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(20,30,40,.28);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 20;
      backdrop-filter: blur(10px);
    }
    .overlay.show{display:flex}
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--r-card);
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      padding: 14px;
      position: relative;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .modalTitle{
      font-weight: 900;
      font-size: 14px;
    }
    .closeX{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid #d9e3f1;
      background:#fff;
      cursor:pointer;
      font-size: 16px;
      display:grid; place-items:center;
    }
    .kv{
      display:grid;
      grid-template-columns: 96px 1fr;
      gap: 8px 10px;
      padding: 10px 6px;
    }
    .k{color:var(--muted); font-size: 12px; font-weight: 800}
    .v{font-size: 13px; font-weight: 900; color:#0b3a66}
    .v.small{font-weight: 700; color:#1f2a37}
    .modalActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--r-pill);
      box-shadow: 0 10px 30px rgba(31,42,55,.18);
      padding: 10px 12px;
      display:none;
      gap: 10px;
      align-items:center;
      z-index: 30;
      backdrop-filter: blur(10px);
      font-size: 12px;
      color:#22415c;
    }
    .toast.show{display:flex}
    .undoBtn{
      border-radius: var(--r-pill);
      border: 1px solid #cfe2ff;
      background: #f7fbff;
      cursor:pointer;
      padding: 6px 10px;
      font-weight: 900;
      color:#0b3a66;
    }

    .muted{color:var(--muted)}
    .hr{
      border:none;
      border-top:1px solid #e6edf7;
      margin: 12px 0;
    }

    /* Mobile padding feel */
    @media (max-width: 480px){
      .sum{font-size: 24px}
      .tabBtn{padding: 10px 10px}
      .leftIcon{width: 38px}
    }
    
    .byCatRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:12px;
      padding: 10px 12px;
      border: 1px solid #e6edf7;
      background:#fff;
      border-radius: var(--r-card);
    }
    .byCatLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .byCatLabel{
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
      /* ===== Graph ===== */
  .chartScroll{
    max-height: 380px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .chartWrap{
    display:grid;
    grid-template-columns: 1fr;
    gap: 0px;
    align-items: start;
  }
  .yAxis{
    display:none; /* â†ç¸¦è»¸ã®æ•°å­—ã‚’æ¶ˆã™ */
    /* display:flex; */
    flex-direction: column;
    align-items: flex-end;
    justify-content: space-between;
  }
  .yTick{
    height: var(--chartStep);
    display:flex;
    align-items:center;
    justify-content:flex-end;
    padding-right: 6px;
    font-size: 12px;
    color: var(--muted);
    font-weight: 800;
    white-space: nowrap;
  }
  .chartArea{
    --chartStep: 20px; /* 1ç›®ç››ã‚Šã®é«˜ã•ï¼ˆè¦‹ãŸç›®ï¼‰ */
    position: relative;
    border: 1px solid var(--line);
    border-radius: var(--r-input);
    padding: 10px;
    background-color: #fff;
    background-clip: content-box;
    background-image:
      repeating-linear-gradient(
        to top,
        transparent 0,
        transparent calc(var(--chartStep) - 1px),
        rgba(219,227,239,.8) calc(var(--chartStep) - 1px),
        rgba(219,227,239,.8) var(--chartStep)
      );
    box-sizing: border-box;
  }
  .bars{
    height: 100%;
    display:flex;
    align-items: flex-end;
    gap: 6px;
  }
  .barBtn{
    flex: 1;
    height: 100%;
    border: 0;
    background: transparent;
    padding: 0;
    display:flex;
    align-items:flex-end;
    cursor: pointer;
      justify-content: center;
  }
  .barFill{
    width: clamp(10px, 70%, 26px);
    background: var(--accent);
    border-radius: 12px 12px 6px 6px;
    box-shadow: 0 8px 18px rgba(120,182,255,.25);
  }
  .barBtn:focus-visible .barFill{
    outline: 3px solid rgba(120,182,255,.55);
    outline-offset: 2px;
  }
  .xAxis{
    display:flex;
    gap: 6px;
    margin-top: 8px;
    padding: 0 10px; /* chartAreaã®å·¦å³paddingã¨åˆã‚ã›ã¦ãƒãƒ¼ã¨ä½ç½®ã‚’æƒãˆã‚‹ */
    box-sizing: border-box;
  }
  .xTick{
    flex:1;
    text-align:center;
    font-size: 11px;
    color: var(--muted);
    font-weight: 800;
    white-space: nowrap;
  }
  
  @media (max-width: 420px){
    .chartArea{ padding: 8px; }
    .xAxis{ padding: 0 8px; gap: 4px; }
    .bars{ gap: 4px; }
    .xTick{ font-size: 10px; }
    .barFill{ width: clamp(8px, 65%, 20px); }
  }


  /* --- mobile tap highlight (iOS/Android) OFF --- */
  :root{
    -webkit-tap-highlight-color: rgba(0,0,0,0);
  }
  a, button, input, select, textarea, .tabBtn, .barBtn{
    -webkit-tap-highlight-color: rgba(0,0,0,0);
  }
  /* remove default focus rectangle on touch; keep keyboard focus via :focus-visible */
  button:focus, .tabBtn:focus, .barBtn:focus{
    outline: none;
    box-shadow: none;
  }
  .tabBtn:focus-visible, .barBtn:focus-visible{
    outline: 2px solid rgba(120, 180, 255, .55);
    outline-offset: 2px;
  }


    /* --- Quick savings toggle (å…ˆå–ã‚Šè²¯é‡‘) --- */
    .amountRow{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .amountRow > input{
      flex:1;
      min-width:0;
    }
    .saveQuick{
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .coinBtn{
      border:1px solid #cfe2ff;
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-size: 14px;
      line-height: 1;
      user-select:none;
    }
    .coinBtn.active{
      background:#d7ecff;
      border-color:#8cc6ff;
      box-shadow: 0 0 0 4px rgba(140,198,255,.25);
    }
    @media (max-width: 360px){
      .saveQuickText{ display:none; }
    }

    /* --- Home summary: show "incl savings" on the right --- */
    .sumRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .sumLeft{ min-width:0; flex:1; }
    .sumRight{
      text-align:right;
      min-width: 130px;
    }
    .incLabel{
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing: .01em;
      margin-top: 2px;
    }
    .incSum{
      font-size: 16px;
      font-weight: 900;
      color:#0b3a66;
      margin-top: 4px;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }


  /* --- Home sum card: align "incl savings" block with main sum + let hint use full width --- */
  @supports (display: grid) and (display: contents) {
    .sumRow{
      display:grid;
      grid-template-columns: 1fr auto;
      column-gap:14px;
      row-gap:6px;
      align-items:end;
    }
    .sumLeft{ display: contents; }
    .month{ grid-column:1; grid-row:1; }
    .sum{ grid-column:1; grid-row:2; }
    .sumRight{ grid-column:2; grid-row:2; align-self:end; }
    .hint{
      grid-column:1 / -1;
      grid-row:3;
      margin-top: 0;
    }
  }


    /* ã‚¿ãƒ–ã®æ ã‚µã‚¤ã‚ºã‚’ä¿ã£ãŸã¾ã¾ã€é¸æŠä¸­ã®å¼·èª¿ã¯â€œå†…å´â€ã§è¡¨ç¾ï¼ˆå¤§ããè¦‹ãˆãªã„ã‚ˆã†ã«ï¼‰ */
    .tabBtn:focus{ outline: none; }
    .tabBtn:focus-visible{ outline: 2px solid rgba(120,182,255,.45); outline-offset: 2px; }

</style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="badge">ğŸ¦…</div>
      <div class="headText">
        <div class="title">æ”¯å‡ºç®¡ç†</div>
        <div class="sub">ç‚ºã›ã°æˆã‚‹ ç‚ºã•ã­ã°æˆã‚‰ã¬ ä½•äº‹ã‚‚ æˆã‚‰ã¬ã¯äººã® ç‚ºã•ã¬ãªã‚Šã‘ã‚ŠğŸ¥</div>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="tabs">
      <button class="tabBtn" role="tab" id="tabbtn-home" aria-controls="tab-home" aria-selected="true"><span class="tabEmoji">ğŸ </span><span class="tabLabel">ãƒ›ãƒ¼ãƒ </span></button>
      <button class="tabBtn" role="tab" id="tabbtn-input" aria-controls="tab-input" aria-selected="false"><span class="tabEmoji">âœï¸</span><span class="tabLabel">å…¥åŠ›</span></button>
      <button class="tabBtn" role="tab" id="tabbtn-ledger" aria-controls="tab-ledger" aria-selected="false"><span class="tabEmoji">ğŸ§¾</span><span class="tabLabel">æ˜ç´°</span></button>
      <button class="tabBtn" role="tab" id="tabbtn-graph" aria-controls="tab-graph" aria-selected="false"><span class="tabEmoji">ğŸ“Š</span><span class="tabLabel">ã‚°ãƒ©ãƒ•</span></button>
    </nav>

    <!-- HOME -->
    <section id="tab-home" role="tabpanel" aria-labelledby="tabbtn-home">
      <div class="card bigSum" id="homeSumCard" title="ã‚¿ãƒƒãƒ—ã§æ˜ç´°ã¸">
        <div class="sumRow">
          <div class="sumLeft">
            <div class="month" id="homeMonth">----</div>
            <div class="sum" id="homeSum">Â¥0</div>
            <div class="hint">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®æœˆã®æ˜ç´°ã«ç§»å‹•ã™ã‚‹ã‚ˆã€‚</div>
          </div>
          <div class="sumRight">
            <div class="incLabel">ã†ã¡ã€å…ˆå–ã‚Šè²¯é‡‘è¾¼ã¿</div>
            <div class="incSum" id="homeSumIncl">Â¥0</div>
          </div>
        </div>
      </div>

      <div class="card" id="homeByCatCard">
        <div class="pill">ğŸ·ï¸ ä»Šæœˆã®å†…è¨³ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰</div>
        <div class="list" id="homeByCatList" style="margin-top:10px;"></div>
        <div class="muted" id="homeByCatEmpty" style="font-size:12px; margin-top:10px; display:none;">ã“ã®æœˆã®æ˜ç´°ã¯ã¾ã ãªã„ã‚ˆã€‚</div>
      </div>

      <div class="card">
        <div class="muted" style="font-size:12px; line-height:1.6;">
          ã“ã“ã¯ä»Šã¯æœ€å°æ§‹æˆã€‚æ¬²ãŒå‡ºã¦ããŸã‚‰ã€Œåå…¥ã€ã€Œæ®‹é«˜ã€ã€Œå…ˆå–ã‚Šè²¯é‡‘ã®æ‰±ã„ã€ã‚‚å¢—ç¯‰ã§ãã‚‹ã€‚
        </div>
      </div>
    
      <div class="card" id="backupCard">
        <div class="pill">ğŸ§° ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
        <div class="muted" style="font-size:12px; line-height:1.6; margin-top:8px;">
          ã“ã®ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ã€Œã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã€ã«ä¿å­˜ã•ã‚Œã‚‹ã‚ˆã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ãƒ»ç«¯æœ«å¤‰æ›´ã«å‚™ãˆã¦ã€JSONã§æ›¸ãå‡ºã—ï¼èª­ã¿è¾¼ã¿ã§ãã‚‹ã€‚
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn" id="exportJsonBtn">â¬‡ï¸ JSONã‚’æ›¸ãå‡ºã™</button>
          <button class="btnGhost" id="exportCsvBtn">â¬‡ï¸ CSVï¼ˆæ˜ç´°ï¼‰</button>
        </div>

        <div style="margin-top:12px;">
          <input type="file" id="importFile" accept="application/json" style="display:none;">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btnGhost" id="chooseImportBtn">â¬†ï¸ JSONã‚’é¸ã¶</button>
            <button class="btn" id="importReplaceBtn" disabled>ğŸ” ç½®ãæ›ãˆ</button>
            <button class="btnGhost" id="importMergeBtn" disabled>â• è¿½åŠ </button>
          </div>
          <div class="muted" id="importInfo" style="font-size:12px; margin-top:8px;">â€»ã€ŒJSONã‚’é¸ã¶ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã‚’é¸ã¶ã¨ã€ã€Œç½®ãæ›ãˆã€ã€Œè¿½åŠ ã€ãŒæŠ¼ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆã€‚</div>
        </div>
      </div>
</section>

    <!-- INPUT -->
    <section id="tab-input" role="tabpanel" aria-labelledby="tabbtn-input" hidden>
      <div class="card">
        <div class="pill" id="inputModePill">âœï¸ è¿½åŠ ãƒ¢ãƒ¼ãƒ‰</div>

        <div class="twoCol">
          <div>
            <label>æ—¥ä»˜</label>
            <input id="inDate" type="date">
          </div>
          <div>
            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
            <div class="amountRow">
              <input id="inAmount" type="number" inputmode="numeric" placeholder="260">
              <div class="saveQuick">
                <span class="saveQuickText">å…ˆå–ã‚Šè²¯é‡‘</span>
                <button type="button" class="coinBtn" id="saveQuickBtn" aria-pressed="false" title="å…ˆå–ã‚Šè²¯é‡‘ã¨ã—ã¦è¨˜éŒ²">ğŸ’°</button>
              </div>
            </div>
          </div>
        </div>

        <label>å†…å®¹ãƒ¡ãƒ¢</label>
        <input id="inMemo" type="text" placeholder="ãŠè“å­ä»£">

        <label>åº—åï¼ˆä»»æ„ï¼‰</label>
        <input id="inStore" type="text" placeholder="ã‚¤ã‚ªãƒ³">

        <label>åˆ†é¡</label>
        <select id="inCat"></select>

        <div class="twoCol" style="margin-top: 12px;">
          <button class="btn" id="saveBtn">â• è¿½åŠ ã™ã‚‹</button>
          <button class="btnGhost" id="resetBtn">ğŸ§½ ãƒ•ã‚©ãƒ¼ãƒ æ¶ˆå»</button>
        </div>

        <hr class="hr">

        <div class="pill">ğŸ•˜ æœ€è¿‘ã®å…¥åŠ›ï¼ˆ5ä»¶ï¼‰</div>
        <div class="list" id="recentList"></div>
        <div class="muted" id="recentEmpty" style="font-size:12px; margin-top:8px; display:none;">ã¾ã å…¥åŠ›ãŒãªã„ã‚ˆã€‚</div>
      </div>
    </section>

    <!-- LEDGER -->
    <section id="tab-ledger" role="tabpanel" aria-labelledby="tabbtn-ledger" hidden>
      <div class="card">
        <div class="ledgerHead">
          <div class="monthNav">
            <button class="miniIconBtn" id="prevMonth" aria-label="å‰ã®æœˆ">â—€</button>
            <div class="pill" id="ledgerMonth">----</div>
            <button class="miniIconBtn" id="nextMonth" aria-label="æ¬¡ã®æœˆ">â–¶</button>
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="miniIconBtn" id="legendBtn" aria-label="å‡¡ä¾‹">ğŸ·ï¸</button>
            <button class="miniIconBtn" id="deleteModeBtn" aria-label="å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰">ğŸ—‘ï¸</button>
          </div>
        </div>

        <div class="legendBox" id="legendBox"></div>

        <div class="pill" style="margin-top:10px;">æ”¯å‡ºé¡ï¼š<span id="ledgerSum" style="font-weight:900; color:#0b3a66;">Â¥0</span></div>

        <div class="list" id="ledgerList" style="margin-top:10px;"></div>
        <div class="muted" id="ledgerEmpty" style="font-size:12px; margin-top:10px; display:none;">ã“ã®æœˆã®æ˜ç´°ã¯ã¾ã ãªã„ã‚ˆã€‚</div>
      </div>
    </section>

  <!-- GRAPH -->
  <section id="tab-graph" role="tabpanel" aria-labelledby="tabbtn-graph" hidden>
    <div class="card">
      <div class="ledgerHead">
        <div class="monthNav">
          <button class="miniIconBtn" id="prevYear" aria-label="å‰ã®å¹´">â—€</button>
          <div class="pill" id="graphYear">----</div>
          <button class="miniIconBtn" id="nextYear" aria-label="æ¬¡ã®å¹´">â–¶</button>
        </div>
        <div class="muted" style="font-size:12px;">ãƒãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã§é‡‘é¡</div>
      </div>

      <div class="chartScroll" id="graphScroll">
        <div class="chartWrap">
          <div class="yAxis" id="graphYAxis"></div>

          <div>
            <div class="chartArea" id="graphArea">
            <div class="bars" id="graphBars"></div>
            </div>
            <div class="xAxis" id="graphXAxis"></div>
          </div>
        </div>
      </div>

      <div class="muted" id="graphEmpty" style="font-size:12px; margin-top:10px; display:none;">ã“ã®å¹´ã¯ã¾ã æ˜ç´°ãŒãªã„ã‚ˆã€‚</div>
    </div>
  </section>
  </div>


  <!-- DETAIL MODAL -->
  <div class="overlay" id="detailOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="modalHead">
        <div class="modalTitle" id="detailTitle">æ˜ç´°ã®è©³ç´°</div>
        <button class="closeX" id="detailClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="kv">
        <div class="k">æ—¥ä»˜</div><div class="v small" id="dDate">-</div>
        <div class="k">é‡‘é¡</div><div class="v" id="dAmount">-</div>
        <div class="k">å†…å®¹</div><div class="v small" id="dMemo">-</div>
        <div class="k">åº—å</div><div class="v small" id="dStore">-</div>
        <div class="k">åˆ†é¡</div><div class="v small" id="dCat">-</div>
      </div>
      <div class="modalActions">
        <button class="btnGhost" id="detailEdit">âœ ç·¨é›†</button>
        <button class="btnDanger" id="detailDelete">ğŸ—‘ï¸ å‰Šé™¤</button>
      </div>
      <div class="muted" style="font-size:12px; margin-top:10px; line-height:1.6;">
        â€» PCã¯ Esc ã§ã‚‚é–‰ã˜ã‚‰ã‚Œã‚‹ã€‚
      </div>
    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div class="overlay" id="confirmOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modalHead">
        <div class="modalTitle" id="confirmTitle">å‰Šé™¤ã™ã‚‹ï¼Ÿ</div>
        <button class="closeX" id="confirmClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="muted" id="confirmText" style="font-size:12px; line-height:1.65; padding: 0 6px 6px;"></div>
      <div class="modalActions">
        <button class="btnDanger" id="confirmYes">ã¯ã„</button>
        <button class="btnGhost" id="confirmNo">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <!-- TOAST (Undo) -->
  <div class="toast" id="toast">
    <div id="toastText">å‰Šé™¤ã—ã¾ã—ãŸ</div>
    <button class="undoBtn" id="undoBtn">â†© å…ƒã«æˆ»ã™</button>
  </div>

  <!-- GRAPH MODAL -->
  <div class="overlay" id="graphOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="graphTitle">
      <div class="modalHead">
        <div class="modalTitle" id="graphTitle">æœˆåˆ¥æ”¯å‡º</div>
        <button class="closeX" id="graphClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="kv">
        <div class="k">å¹´æœˆ</div><div class="v small" id="gYM">-</div>
        <div class="k">é‡‘é¡</div><div class="v" id="gAmount">-</div>
      </div>
    </div>
  </div>

<script>
  // ===== Data =====
  const KEY = "sishutsu_entries_v01";
  const UIKEY = "sishutsu_ui_v01";

  const CATS = [
    { key:"food_buy",   label:"é£Ÿè²»:è²·ã„å‡ºã—ğŸ™", icon:"ğŸ™" },
    { key:"food_treat", label:"é£Ÿè²»:å—œå¥½ğŸ¥¨",     icon:"ğŸ¥¨" },
    { key:"Connect",    label:"é€šä¿¡è²»ğŸ“±",        icon:"ğŸ“±" },
    { key:"daily",      label:"æ—¥ç”¨å“è²»ğŸ§»",       icon:"ğŸ§»" },
    { key:"transport",  label:"äº¤é€šè²»ğŸšƒ",         icon:"ğŸšƒ" },
    { key:"medical",    label:"åŒ»ç™‚è²»ğŸ©º",         icon:"ğŸ©º" },
    { key:"social",     label:"äº¤éš›è²»ğŸ›ï¸",        icon:"ğŸ›ï¸" },
    { key:"fun",        label:"å¨¯æ¥½è²»ğŸ®",         icon:"ğŸ®" },
    { key:"fixed",      label:"å›ºå®šè²»ğŸ“Œ",         icon:"ğŸ“Œ" },
    { key:"utility_volt",label:"å…‰ç†±è²»:é›»æ°—ğŸ’¡",  icon:"ğŸ’¡" },
    { key:"utility_gas", label:"å…‰ç†±è²»:ã‚¬ã‚¹ğŸ³",  icon:"ğŸ³" },
    { key:"utility_oil", label:"å…‰ç†±è²»:ç¯æ²¹ğŸ”¥",  icon:"ğŸ”¥" },
    { key:"save",       label:"å…ˆå–ã‚Šè²¯é‡‘ğŸ’°",     icon:"ğŸ’°" },
    { key:"other",      label:"ãã®ä»–ğŸ¤",         icon:"ğŸ¤" },
  ];
  const CATMAP = Object.fromEntries(CATS.map(c => [c.key, c]));

  function loadEntries(){
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }
  function saveEntries(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }
  function loadUI(){
    try { return JSON.parse(localStorage.getItem(UIKEY) || "{}"); }
    catch { return {}; }
  }
  function saveUI(obj){
    localStorage.setItem(UIKEY, JSON.stringify(obj));
  }

  function yen(n){
    const v = Number(n || 0);
    return new Intl.NumberFormat("ja-JP", { style:"currency", currency:"JPY", maximumFractionDigits:0 }).format(v);
  }
  function todayISO(){
    const d = new Date();
    const tz = d.getTimezoneOffset() * 60000;
    return new Date(Date.now() - tz).toISOString().slice(0,10);
  }
  function monthKey(dateStr){
    return (dateStr || "").slice(0,7); // YYYY-MM
  }
  function monthLabel(m){
    if(!m) return "----";
    return m.replace("-", "å¹´") + "æœˆ";
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ===== State =====
  let state = {
    tab: "home",
    selectedMonth: monthKey(todayISO()),
    selectedYear: Number(todayISO().slice(0,4)),
    deleteMode: false,
    legendOpen: false,
    editingId: null,
    detailId: null,

    // undo
    lastDeleted: null,
    toastTimer: null,
  };

  // ===== Init UI =====
  const inCat = document.getElementById("inCat");
  for(const c of CATS){
    const opt = document.createElement("option");
    opt.value = c.key;
    opt.textContent = c.label;
    inCat.appendChild(opt);
  }

  document.getElementById("inDate").value = todayISO();

  // ===== Quick toggle: å…ˆå–ã‚Šè²¯é‡‘ğŸ’° =====
  const saveQuickBtn = document.getElementById("saveQuickBtn");
  let prevCatBeforeSave = null;

  function syncSaveQuick(){
    if(!saveQuickBtn) return;
    const active = (inCat.value === "save");
    saveQuickBtn.classList.toggle("active", active);
    saveQuickBtn.setAttribute("aria-pressed", active ? "true" : "false");
  }

  if(saveQuickBtn){
    saveQuickBtn.addEventListener("click", ()=>{
      if(inCat.value !== "save"){
        prevCatBeforeSave = inCat.value;
        inCat.value = "save";
      }else{
        // toggle off: restore previous category if possible
        const fallback = (prevCatBeforeSave && prevCatBeforeSave !== "save")
          ? prevCatBeforeSave
          : (CATS.find(c=>c.key !== "save")?.key || "other");
        inCat.value = fallback;
      }
      syncSaveQuick();
    });

    // if user changes category manually, keep button state consistent
    inCat.addEventListener("change", syncSaveQuick);
    syncSaveQuick();
  }


  // ===== Tabs =====
  function setTab(name){
    state.tab = name;
    const tabs = ["home","input","ledger","graph"];
    for(const t of tabs){
      document.getElementById(`tab-${t}`).hidden = (t !== name);
      document.getElementById(`tabbtn-${t}`).setAttribute("aria-selected", t === name ? "true" : "false");
    }
    saveUI({...loadUI(), tab: state.tab});
  }
  document.getElementById("tabbtn-home").addEventListener("click", ()=> setTab("home"));
  document.getElementById("tabbtn-input").addEventListener("click", ()=> setTab("input"));
  document.getElementById("tabbtn-ledger").addEventListener("click", ()=> setTab("ledger"));
  document.getElementById("tabbtn-graph").addEventListener("click", ()=> setTab("graph"));


  // ===== Month selection =====
  function computeLatestMonth(entries){
    if(!entries.length) return monthKey(todayISO());
    const sorted = [...entries].sort((a,b)=> (a.date < b.date ? 1 : -1));
    return monthKey(sorted[0].date);
  }
  function setSelectedMonth(m){
    state.selectedMonth = m;
    saveUI({...loadUI(), selectedMonth: m});
  }

  function setSelectedYear(y){
    state.selectedYear = y;
    saveUI({...loadUI(), selectedYear: y});
  }
  function computeLatestYear(entries){
    if(!entries.length) return Number(todayISO().slice(0,4));
    const sorted = [...entries].sort((a,b)=> (a.date < b.date ? 1 : -1));
    return Number(sorted[0].date.slice(0,4));
  }

  // Month nav
  function addMonths(ym, delta){
    const y = Number(ym.slice(0,4));
    const m = Number(ym.slice(5,7));
    const d = new Date(y, m-1 + delta, 1);
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${d.getFullYear()}-${mm}`;
  }
  document.getElementById("prevMonth").addEventListener("click", ()=>{
    setSelectedMonth(addMonths(state.selectedMonth, -1));
    renderAll();
  });
  document.getElementById("nextMonth").addEventListener("click", ()=>{
    setSelectedMonth(addMonths(state.selectedMonth, 1));
    renderAll();
  });

  document.getElementById("prevYear").addEventListener("click", ()=>{
    setSelectedYear(state.selectedYear - 1);
    renderGraph();
  });
  document.getElementById("nextYear").addEventListener("click", ()=>{
    setSelectedYear(state.selectedYear + 1);
    renderGraph();
  });

  // ===== Home behavior =====
  document.getElementById("homeSumCard").addEventListener("click", ()=>{
  // â˜…ãƒ›ãƒ¼ãƒ ãŒè¦‹ã¦ã‚‹æœ€æ–°æœˆã‚’æ˜ç´°ã«åæ˜ ã—ã¦ã‹ã‚‰ç§»å‹•
    const latest = state.latestMonth || computeLatestMonth(loadEntries());
    setSelectedMonth(latest);

    setTab("ledger");
    renderAll();
  });

  // ===== Delete mode + legend =====
  const deleteModeBtn = document.getElementById("deleteModeBtn");
  deleteModeBtn.addEventListener("click", ()=>{
    state.deleteMode = !state.deleteMode;
    deleteModeBtn.classList.toggle("on", state.deleteMode);
    renderLedger();
  });

  const legendBtn = document.getElementById("legendBtn");
  const legendBox = document.getElementById("legendBox");
  legendBtn.addEventListener("click", ()=>{
    state.legendOpen = !state.legendOpen;
    legendBox.classList.toggle("show", state.legendOpen);
  });

  function renderLegend(){
    const lines = CATS.map(c => `${c.icon} ï¼ ${escapeHtml(c.label.replace(/^[^:]+:/, m => m))}`);
    // label is already nice; keep ê·¸ëŒ€ë¡œ
    legendBox.innerHTML = lines.map(s => `<div>${s}</div>`).join("");
  }

  // ===== Add / Edit =====
  const inputModePill = document.getElementById("inputModePill");
  const saveBtn = document.getElementById("saveBtn");

  function resetForm(keepDate=true, keepCat=true){
    if(!keepDate) document.getElementById("inDate").value = todayISO();
    document.getElementById("inAmount").value = "";
    document.getElementById("inMemo").value = "";
    document.getElementById("inStore").value = "";
    if(!keepCat){
      document.getElementById("inCat").value = "food_treat";
      document.getElementById("inCat").dispatchEvent(new Event("change"));
    }
  }

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    resetForm(true, true);
  });

  function setEditMode(id){
    const entries = loadEntries();
    const e = entries.find(x => x.id === id);
    if(!e) return;
    state.editingId = id;
    inputModePill.textContent = "âœ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
    saveBtn.textContent = "âœ… æ›´æ–°ã™ã‚‹";

    document.getElementById("inDate").value = e.date;
    document.getElementById("inAmount").value = e.amount;
    document.getElementById("inMemo").value = e.memo;
    document.getElementById("inStore").value = e.store || "";
    document.getElementById("inCat").value = e.catKey;
    document.getElementById("inCat").dispatchEvent(new Event("change"));

    setTab("input");
  }

  function clearEditMode(){
    state.editingId = null;
    inputModePill.textContent = "âœï¸ è¿½åŠ ãƒ¢ãƒ¼ãƒ‰";
    saveBtn.textContent = "â• è¿½åŠ ã™ã‚‹";
  }

  saveBtn.addEventListener("click", ()=>{
    const date = document.getElementById("inDate").value;
    const amount = Number(document.getElementById("inAmount").value);
    const memo = document.getElementById("inMemo").value.trim() || "ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰";
    const store = document.getElementById("inStore").value.trim();
    const catKey = document.getElementById("inCat").value;

    if(!date){ alert("æ—¥ä»˜ãŒå¿…è¦"); return; }
    if(!Number.isFinite(amount) || amount <= 0){ alert("é‡‘é¡ãŒå¿…è¦"); return; }

    const entries = loadEntries();

    if(state.editingId){
      const idx = entries.findIndex(x => x.id === state.editingId);
      if(idx === -1){ clearEditMode(); return; }

      entries[idx] = {
        ...entries[idx],
        date, amount, memo, store, catKey,
        updatedAt: Date.now(),
      };
      saveEntries(entries);

      const updated = entries[idx];
      clearEditMode();

      // ç·¨é›†å¾Œã¯ã€Œè©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«æˆ»ã‚‹ã€ï¼šè©²å½“æœˆã¸åˆ‡æ›¿ â†’ æ˜ç´°ã‚¿ãƒ– â†’ è©³ç´°
      setSelectedMonth(monthKey(updated.date));
      setTab("ledger");
      renderAll();
      openDetail(updated.id);
      return;
    }

    // add
    const id = crypto.randomUUID();
    entries.push({
      id,
      date,
      amount,
      memo,
      store,
      catKey,
      createdAt: Date.now(),
      updatedAt: null,
    });
    saveEntries(entries);

    // è¿½åŠ å¾Œã®æŒ™å‹•ï¼šæ—¥ä»˜ã¨åˆ†é¡ã¯ä¿æŒã€é‡‘é¡/ãƒ¡ãƒ¢/åº—åã¯æ¶ˆã™
    resetForm(true, true);

    // æœ€æ–°æœˆæ›´æ–°
    const latest = computeLatestMonth(entries);
    setSelectedMonth(latest);

    renderAll();
    showToast("è¿½åŠ ã—ãŸã‚ˆâœ…", false);
  });

  // ===== Rendering =====
  function renderHome(){
    const entries = loadEntries();
    const latest = computeLatestMonth(entries);

    // Home shows latest month sum and sets selectedMonth to latest
    const inLatest = entries.filter(e => monthKey(e.date) === latest);
    const sumAll = inLatest.reduce((s,e)=> s + Number(e.amount||0), 0);
    const sumNoSave = inLatest.filter(e => (e.catKey||"") !== "save").reduce((s,e)=> s + Number(e.amount||0), 0);
document.getElementById("homeMonth").textContent = monthLabel(latest);
    document.getElementById("homeSum").textContent = yen(sumNoSave);
    const inclEl = document.getElementById("homeSumIncl");
    if(inclEl) inclEl.textContent = yen(sumAll);
    
    state.latestMonth = latest; // â˜…è¿½åŠ ï¼ˆselectedMonthã¯è§¦ã‚‰ãªã„ï¼‰
    renderHomeBreakdown(latest);
  }

  function renderHomeBreakdown(month){
    const entries = loadEntries();
    const list = entries.filter(e => monthKey(e.date) === month);

    const sums = new Map(); // catKey -> amount
    for(const e of list){
      const k = e.catKey || "other";
      sums.set(k, (sums.get(k) || 0) + Number(e.amount || 0));
    }

    const rows = [];
    for(const [catKey, amt] of sums.entries()){
      const cat = CATMAP[catKey] || { label:"ãã®ä»–ğŸ¤", icon:"ğŸ¤" };
      if(amt > 0){
        rows.push({ catKey, label: cat.label, icon: cat.icon, amt });
      }
    }

    rows.sort((a,b)=> b.amt - a.amt); // é‡‘é¡ã®å¤§ãã„é †

    const box = document.getElementById("homeByCatList");
    const empty = document.getElementById("homeByCatEmpty");

    if(!rows.length){
      box.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    box.innerHTML = rows.map(r => `
      <div class="byCatRow">
        <div class="byCatLeft">
          <div class="catEmoji" title="${escapeHtml(r.label)}">${r.icon}</div>
          <div class="byCatLabel">${escapeHtml(r.label)}</div>
        </div>
        <div class="amount">${yen(r.amt)}</div>
      </div>
    `).join("");
  }

  function rowHTML(e, mode){
    // mode: "ledger" | "recent"
    const cat = CATMAP[e.catKey] || {icon:"ğŸ¤", label:"ãã®ä»–ğŸ¤"};
    const mmdd = e.date.slice(5).replace("-","/");
    const storeLine = (e.store && e.store.trim()) ? `<div class="line2">ğŸª ${escapeHtml(e.store.trim())}</div>` : "";
    const memo = escapeHtml(e.memo || "ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰");

    // Deletion button on right only in ledger delete mode
    const showTrashRight = (mode === "ledger" && state.deleteMode);

    return `
      <div class="rowItem" data-id="${e.id}">
        <div class="leftIcon">
          <div class="catEmoji" title="${escapeHtml(cat.label)}">${cat.icon}</div>
        </div>

        <div class="tapArea" data-tap="${e.id}">
          <div class="line1">
            <div class="mainRowLeft">
              <div class="dateMini">${mmdd}</div>
              <div class="memo" title="${memo}">${memo}</div>
            </div>
            <div class="amount">${yen(e.amount)}</div>
          </div>
          ${storeLine}
        </div>

        ${showTrashRight ? `<button class="trashBtn" data-trash="${e.id}" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : ``}
      </div>
    `;
  }

  function attachRowHandlers(container, mode){
    // ã‚¿ãƒƒãƒ— â†’ è©³ç´°ï¼ˆå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ç„¡åŠ¹ï¼‰
    container.querySelectorAll("[data-tap]").forEach(area=>{
      area.addEventListener("click", ()=>{
        const id = area.getAttribute("data-tap");
        if(mode === "ledger" && state.deleteMode) return;
        openDetail(id);
      });
    });

    // æ˜ç´°ï¼ˆå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ï¼‰ã®ğŸ—‘ï¸
    container.querySelectorAll("[data-trash]").forEach(btn=>{
      btn.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        const id = btn.getAttribute("data-trash");
        askDelete(id);
      });
    });
  }

  function renderRecent(){
    const entries = loadEntries()
      .slice()
      .sort((a,b)=> (a.date < b.date ? 1 : (a.date > b.date ? -1 : (b.createdAt||0)-(a.createdAt||0)) ));

    const recent = entries.slice(0,5);
    const box = document.getElementById("recentList");
    const empty = document.getElementById("recentEmpty");

    if(!recent.length){
      box.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";
    box.innerHTML = recent.map(e => rowHTML(e, "recent")).join("");
    attachRowHandlers(box, "recent");
  }

  function renderLedger(){
    renderLegend();

    const entries = loadEntries();
    const m = state.selectedMonth;

    document.getElementById("ledgerMonth").textContent = monthLabel(m);

    const list = entries
      .filter(e => monthKey(e.date) === m)
      .slice()
      .sort((a,b)=> (a.date < b.date ? 1 : (a.date > b.date ? -1 : (b.createdAt||0)-(a.createdAt||0)) ));

    const sum = list.reduce((s,e)=> s + Number(e.amount||0), 0);
    document.getElementById("ledgerSum").textContent = yen(sum);

    const box = document.getElementById("ledgerList");
    const empty = document.getElementById("ledgerEmpty");

    deleteModeBtn.classList.toggle("on", state.deleteMode);

    if(!list.length){
      box.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    box.innerHTML = list.map(e => rowHTML(e, "ledger")).join("");
    attachRowHandlers(box, "ledger");
  }

  function renderGraph(){
    const entries = loadEntries();
    const y = state.selectedYear;

    document.getElementById("graphYear").textContent = `${y}å¹´`;

    const sums = Array(12).fill(0);
    for(const e of entries){
      if(!e.date) continue;
      if(Number(e.date.slice(0,4)) !== y) continue;
      const m = Number(e.date.slice(5,7)) - 1;
      if(m>=0 && m<12) sums[m] += Number(e.amount || 0);
    }

    const max = Math.max(...sums, 0);

    // --- auto scale (keeps the card height comfortable) ---
    // åŸºæœ¬ã¯2ä¸‡å††åˆ»ã¿ã€‚æœ€å¤§é¡ãŒå¤§ãã„æœˆã ã‘ã€è‡ªå‹•ã§åˆ»ã¿å¹…ã‚’åºƒã’ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é¿ã‘ã‚‹ã€‚
    const STEP_CANDIDATES = [20000, 50000, 100000, 200000, 500000]; // 2ä¸‡â†’5ä¸‡â†’10ä¸‡â†’â€¦
    const MAX_TICKS = 15;  // ã“ã®æœ¬æ•°ã‚’è¶…ãˆã‚‹ã¨ç¸¦ã«é•·ããªã‚Šã™ãã‚‹
    const MIN_TICKS = 10;  // å°‘ãªã™ãã‚‹ã¨ã‚¹ã‚«ã‚¹ã‚«ã«ãªã‚‹ã®ã§æœ€ä½æœ¬æ•°ã‚’ç¢ºä¿

    let STEP_YEN = STEP_CANDIDATES[0];
    let kMax = 0;

    for(const s of STEP_CANDIDATES){
      STEP_YEN = s;
      kMax = Math.ceil(max / STEP_YEN);
      if(kMax <= MAX_TICKS) break;
    }
    if(kMax < MIN_TICKS) kMax = MIN_TICKS;

    const area = document.getElementById("graphArea");
    const yAxis = document.getElementById("graphYAxis");
    const bars = document.getElementById("graphBars");
    const xAxis = document.getElementById("graphXAxis");
    const empty = document.getElementById("graphEmpty");
    const scroll = document.getElementById("graphScroll");

    const stepPx = 20; // 1ç›®ç››ã‚Šã®è¦‹ãŸç›®ï¼ˆé«˜ã•ï¼‰
    const h = kMax * stepPx;

    area.style.setProperty("--chartStep", stepPx + "px");
    area.style.height = h + "px";
    yAxis.style.height = h + "px";

    // y axis labelsï¼ˆ10,000å†† = 1ä¸‡ï¼‰
// ä»Šå›ã¯ã€Œæ•°å­—ã¯æ¶ˆã—ãŸã„ã€é‹ç”¨ãªã®ã§ã€æç”»ã¯ã—ãªã„ï¼ˆè¦‹ãŸç›®ãŒåºƒããªã‚‹ï¼‰
yAxis.innerHTML = "";
yAxis.style.display = "none";

    // x axis labels
xAxis.innerHTML = "";
const narrow = window.matchMedia && window.matchMedia("(max-width: 420px)").matches;
for(let m=1; m<=12; m++){
  const d = document.createElement("div");
  d.className = "xTick";
  // ã‚¹ãƒãƒ›å¹…ã ã¨ã€Œ11æœˆã€ã€Œ12æœˆã€ãŒçª®å±ˆãªã®ã§çŸ­ç¸®è¡¨ç¤ºï¼ˆ1ã€œ12ï¼‰
  d.textContent = narrow ? String(m) : `${m}æœˆ`;
  xAxis.appendChild(d);
}

    // bars
    bars.innerHTML = "";
    for(let i=0; i<12; i++){
      const amt = sums[i];
      const pctRaw = (amt / (kMax * STEP_YEN)) * 100;
      const pct = (amt > 0) ? Math.max(2, pctRaw) : 0;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "barBtn";
      btn.setAttribute("aria-label", `${y}å¹´${i+1}æœˆ ${yen(amt)}`);

      const fill = document.createElement("div");
      fill.className = "barFill";
      fill.style.height = pct + "%";

      btn.appendChild(fill);
      btn.addEventListener("click", ()=>{
        openGraphMonth(y, i+1, amt);
      });

      bars.appendChild(btn);
    }

    // empty message
    const hasAny = sums.some(v => v > 0);
    empty.style.display = hasAny ? "none" : "block";

    // å¹´ãŒå¤§ããã¦ç¸¦ã«é•·ã„æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¦‹ã›ã‚‹ï¼ˆå‹æ‰‹ã«OKï¼‰
    if(scroll) scroll.scrollTop = 0;
  }

  function renderAll(){
    renderHome();
    renderRecent();
    renderLedger();
    renderGraph();
  }

  // ===== Detail modal =====
  const detailOverlay = document.getElementById("detailOverlay");
  const detailClose = document.getElementById("detailClose");

  function openDetail(id){
    const entries = loadEntries();
    const e = entries.find(x => x.id === id);
    if(!e) return;

    state.detailId = id;

    const cat = CATMAP[e.catKey] || {label:"ãã®ä»–ğŸ¤", icon:"ğŸ¤"};
    document.getElementById("dDate").textContent = e.date;
    document.getElementById("dAmount").textContent = yen(e.amount);
    document.getElementById("dMemo").textContent = e.memo || "ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰";
    document.getElementById("dStore").textContent = (e.store && e.store.trim()) ? e.store.trim() : "ï¼ˆãªã—ï¼‰";
    document.getElementById("dCat").textContent = cat.label;

    showOverlay(detailOverlay, true);
  }
  function closeDetail(){
    showOverlay(detailOverlay, false);
    state.detailId = null;
  }
  detailClose.addEventListener("click", closeDetail);

  // click outside to close (optional; keeps your earlier preference OK)
  detailOverlay.addEventListener("click", (ev)=>{
    if(ev.target === detailOverlay) closeDetail();
  });

  document.getElementById("detailEdit").addEventListener("click", ()=>{
    if(!state.detailId) return;
    const id = state.detailId;
    closeDetail();
    setEditMode(id);
  });

  document.getElementById("detailDelete").addEventListener("click", ()=>{
    if(!state.detailId) return;
    const id = state.detailId;
    // keep detail open? we'll ask confirm over it
    askDelete(id, {fromDetail:true});
  });

  const graphOverlay = document.getElementById("graphOverlay");
  const graphClose = document.getElementById("graphClose");

  function openGraphMonth(y, m, amt){
    document.getElementById("gYM").textContent = `${y}å¹´${m}æœˆ`;
    document.getElementById("gAmount").textContent = yen(amt);
    showOverlay(graphOverlay, true);
  }
  function closeGraph(){
    showOverlay(graphOverlay, false);
  }

  graphClose.addEventListener("click", closeGraph);
  graphOverlay.addEventListener("click", (ev)=>{
    if(ev.target === graphOverlay) closeGraph();
  });

  // ESC closes detail/confirm
  document.addEventListener("keydown", (ev)=>{
    if(ev.key === "Escape"){
      if(confirmOverlay.classList.contains("show")) closeConfirm();
      else if(detailOverlay.classList.contains("show")) closeDetail();
      else if(graphOverlay.classList.contains("show")) closeGraph();
    }
  });

  // ===== Confirm delete =====
  const confirmOverlay = document.getElementById("confirmOverlay");
  const confirmClose = document.getElementById("confirmClose");
  const confirmText = document.getElementById("confirmText");
  const confirmYes = document.getElementById("confirmYes");
  const confirmNo = document.getElementById("confirmNo");

  let pendingDeleteId = null;
  let pendingFromDetail = false;

  function askDelete(id, opts={}){
    const entries = loadEntries();
    const e = entries.find(x => x.id === id);
    if(!e) return;

    pendingDeleteId = id;
    pendingFromDetail = !!opts.fromDetail;

    const cat = CATMAP[e.catKey] || {label:"ãã®ä»–ğŸ¤", icon:"ğŸ¤"};
    const line = `${e.date} / ${cat.label} / ${e.memo || "ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰"} / ${yen(e.amount)}`;
    confirmText.textContent = line;

    showOverlay(confirmOverlay, true);
  }

  function closeConfirm(){
    showOverlay(confirmOverlay, false);
    pendingDeleteId = null;
    pendingFromDetail = false;
  }
  confirmClose.addEventListener("click", closeConfirm);
  confirmNo.addEventListener("click", closeConfirm);
  confirmOverlay.addEventListener("click", (ev)=>{
    if(ev.target === confirmOverlay) closeConfirm();
  });

  confirmYes.addEventListener("click", ()=>{
    if(!pendingDeleteId) return;

    const entries = loadEntries();
    const idx = entries.findIndex(x => x.id === pendingDeleteId);
    if(idx === -1){ closeConfirm(); return; }

    // keep for undo
    state.lastDeleted = entries[idx];
    entries.splice(idx, 1);
    saveEntries(entries);

    closeConfirm();

    // if delete triggered from detail, close detail too
    if(pendingFromDetail){
      closeDetail();
    }

    renderAll();
    showToast("å‰Šé™¤ã—ã¾ã—ãŸ", true);
  });

  // ===== Overlay helper =====
  function showOverlay(el, show){
    el.classList.toggle("show", show);
    el.setAttribute("aria-hidden", show ? "false" : "true");
  }

  // ===== Toast (Undo) =====
  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");
  const undoBtn = document.getElementById("undoBtn");

  function showToast(text, canUndo){
    toastText.textContent = text;
    undoBtn.style.display = canUndo ? "inline-block" : "none";
    toast.classList.add("show");

    if(state.toastTimer) clearTimeout(state.toastTimer);
    state.toastTimer = setTimeout(()=>{
      toast.classList.remove("show");
      state.toastTimer = null;
      if(!canUndo) return;
      // time out -> commit delete (do nothing)
      state.lastDeleted = null;
    }, canUndo ? 4500 : 1800);
  }

  undoBtn.addEventListener("click", ()=>{
    if(!state.lastDeleted) return;
    const entries = loadEntries();
    entries.push(state.lastDeleted);
    saveEntries(entries);
    state.lastDeleted = null;
    toast.classList.remove("show");
    renderAll();
  });

  // ===== Restore UI state =====
  function boot(){
    const ui = loadUI();
    if(ui.tab) setTab(ui.tab);
    if(ui.selectedMonth) setSelectedMonth(ui.selectedMonth);

    const entries = loadEntries();
    const y = ui.selectedYear ? Number(ui.selectedYear) : computeLatestYear(entries);
    setSelectedYear(y);

    const inCatEl = document.getElementById("inCat");
    if(inCatEl) inCatEl.value = "food_treat";

    renderAll();
    wireBackupUI();
  }

  // ===== Backup / Export / Import =====
  function safeUUID(){
    try { return crypto.randomUUID(); }
    catch { return "id_" + Date.now() + "_" + Math.random().toString(16).slice(2); }
  }

  function buildBackup(){
    return {
      app: "sishutsu-app",
      backupVersion: 1,
      createdAt: new Date().toISOString(),
      entriesKey: KEY,
      uiKey: UIKEY,
      entries: loadEntries(),
      ui: loadUI(),
    };
  }

  function downloadText(filename, text, mime){
    const blob = new Blob([text], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  }

  function csvEscape(v){
    const s = String(v ?? "");
    if(/[,"\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function exportCSV(){
    const entries = loadEntries().slice().sort((a,b)=> (a.date < b.date ? -1 : 1));
    const header = ["date","amount","category","store","memo","createdAt","updatedAt"];
    const rows = [header.join(",")];
    for(const e of entries){
      const cat = (CATMAP[e.catKey] ? CATMAP[e.catKey].label : e.catKey);
      rows.push([
        e.date,
        Number(e.amount||0),
        cat,
        e.store||"",
        e.memo||"",
        e.createdAt||"",
        e.updatedAt||"",
      ].map(csvEscape).join(","));
    }
    // Excelå‘ã‘ã«BOMã‚’ä»˜ã‘ã‚‹
    const bom = "\ufeff";
    const text = bom + rows.join("\n");
    const d = todayISO().replaceAll("-","");
    downloadText(`sishutsu_meisai_${d}.csv`, text, "text/csv;charset=utf-8");
    showToast("CSVã‚’æ›¸ãå‡ºã—ãŸã‚ˆâœ…", false);
  }

  function normalizeDateString(s){
    const str = String(s||"").trim();
    // Accept YYYY-MM-DD or YYYY/MM/DD
    const m = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if(!m) return null;
    const y = m[1];
    const mo = String(m[2]).padStart(2,"0");
    const d = String(m[3]).padStart(2,"0");
    return `${y}-${mo}-${d}`;
  }

  function sanitizeEntry(raw, usedIds){
    if(!raw || typeof raw !== "object") return null;
    const date = normalizeDateString(raw.date);
    if(!date) return null;

    let amount = Number(raw.amount);
    if(!Number.isFinite(amount)) amount = 0;
    amount = Math.round(amount);

    let catKey = String(raw.catKey || raw.cat || "other");
    if(!CATMAP[catKey]) catKey = "other";

    let id = String(raw.id || "").trim();
    if(!id || usedIds.has(id)) id = safeUUID();
    usedIds.add(id);

    const memo = String(raw.memo || "").slice(0, 500);
    const store = String(raw.store || "").slice(0, 200);

    let createdAt = Number(raw.createdAt);
    if(!Number.isFinite(createdAt)) createdAt = Date.now();
    let updatedAt = raw.updatedAt === null || raw.updatedAt === undefined ? null : Number(raw.updatedAt);
    if(updatedAt !== null && !Number.isFinite(updatedAt)) updatedAt = null;

    return { id, date, amount, memo, store, catKey, createdAt, updatedAt };
  }

  function parseBackupObject(obj){
    // 1) root is entries array
    if(Array.isArray(obj)) return { entries: obj, ui: null };

    // 2) root has entries
    if(obj && typeof obj === "object"){
      if(Array.isArray(obj.entries)) return { entries: obj.entries, ui: (obj.ui && typeof obj.ui==="object") ? obj.ui : null };
      // 3) some nested formats
      if(obj.data && Array.isArray(obj.data.entries)) return { entries: obj.data.entries, ui: (obj.data.ui && typeof obj.data.ui==="object") ? obj.data.ui : null };
    }
    return null;
  }

  let pendingImport = null;

  function setImportInfo(text){
    const el = document.getElementById("importInfo");
    if(el) el.textContent = text || "";
  }

  function setImportButtons(enabled){
    const rep = document.getElementById("importReplaceBtn");
    const mer = document.getElementById("importMergeBtn");
    if(rep) rep.disabled = !enabled;
    if(mer) mer.disabled = !enabled;
  }

  function applyImport(mode){
    if(!pendingImport) return;

    const existing = loadEntries();
    const usedIds = new Set(existing.map(e => e.id));

    const incomingRaw = pendingImport.entries || [];
    const sanitized = [];
    const used = new Set(mode === "merge" ? usedIds : []);
    for(const r of incomingRaw){
      const e = sanitizeEntry(r, used);
      if(e) sanitized.push(e);
    }

    let merged = sanitized;
    if(mode === "merge"){
      merged = existing.concat(sanitized);
    }

    // sort just in case
    merged.sort((a,b)=> (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));

    saveEntries(merged);

    // UIã¯ã€Œç½®ãæ›ãˆã€ã®æ™‚ã ã‘ã€å…¥ã£ã¦ãŸã‚‰åæ˜ ï¼ˆãªã‘ã‚Œã°ä»Šã®ã¾ã¾ï¼‰
    if(mode === "replace" && pendingImport.ui){
      const keep = loadUI();
      // å®‰å…¨ã®ãŸã‚ã€ä½¿ã†ã®ã¯ã“ã®3ã¤ã ã‘
      const ui = {
        tab: pendingImport.ui.tab || keep.tab,
        selectedMonth: pendingImport.ui.selectedMonth || keep.selectedMonth,
        selectedYear: pendingImport.ui.selectedYear || keep.selectedYear,
      };
      saveUI(ui);
    }

    pendingImport = null;
    setImportButtons(false);
    setImportInfo("");

    // ã„ã¾è¦‹ã‚„ã™ã„ã‚ˆã†ã«æœ€æ–°æœˆã¸å¯„ã›ã‚‹
    const latest = computeLatestMonth(merged);
    setSelectedMonth(latest);
    setSelectedYear(Number(latest.slice(0,4)));

    renderAll();
    showToast(mode === "merge" ? "è¿½åŠ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã‚ˆâœ…" : "ç½®ãæ›ãˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã‚ˆâœ…", false);
  }

  function wireBackupUI(){
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const chooseImportBtn = document.getElementById("chooseImportBtn");
    const importFile = document.getElementById("importFile");
    const importReplaceBtn = document.getElementById("importReplaceBtn");
    const importMergeBtn = document.getElementById("importMergeBtn");

    if(exportJsonBtn){
      exportJsonBtn.addEventListener("click", ()=>{
        const backup = buildBackup();
        const text = JSON.stringify(backup, null, 2);
        const d = todayISO().replaceAll("-","");
        downloadText(`sishutsu_backup_${d}.json`, text, "application/json;charset=utf-8");
        showToast("JSONã‚’æ›¸ãå‡ºã—ãŸã‚ˆâœ…", false);
      });
    }

    if(exportCsvBtn){
      exportCsvBtn.addEventListener("click", exportCSV);
    }

    if(chooseImportBtn && importFile){
      chooseImportBtn.addEventListener("click", ()=> importFile.click());
    }

    if(importFile){
      importFile.addEventListener("change", async ()=>{
        const file = importFile.files && importFile.files[0];
        pendingImport = null;
        setImportButtons(false);
        if(!file){
          setImportInfo("");
          return;
        }

        try{
          const text = await file.text();
          const obj = JSON.parse(text);
          const parsed = parseBackupObject(obj);
          if(!parsed){
            setImportInfo("ã“ã®JSONã¯å½¢å¼ãŒé•ã†ã¿ãŸã„ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆentrieså…¥ã‚Šï¼‰ã˜ã‚ƒãªã„ã‹ã‚‚ã€‚");
            return;
          }
          // count sanitize-able entries
          const used = new Set(loadEntries().map(e=>e.id));
          let ok = 0;
          for(const r of parsed.entries){
            const e = sanitizeEntry(r, used);
            if(e) ok++;
          }
          pendingImport = parsed;
          setImportButtons(true);
          setImportInfo(`é¸æŠä¸­: ${file.name} / èª­ã¿è¾¼ã¿å€™è£œ: ${ok} ä»¶`);
        }catch(err){
          setImportInfo("èª­ã¿è¾¼ã¿å¤±æ•—â€¦JSONãŒå£Šã‚Œã¦ã‚‹ã‹ã‚‚ã€‚");
        }
        try{ importFile.value = ""; }catch(e){}
      });
    }

    if(importReplaceBtn){
      importReplaceBtn.addEventListener("click", ()=>{
        if(!pendingImport) return;
        const ok = confirm("ä»Šã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å†…å®¹ã§ç½®ãæ›ãˆã‚‹ã‚ˆã€‚ã‚ˆã‘ã‚Œã°OKã€‚");
        if(ok) applyImport("replace");
      });
    }

    if(importMergeBtn){
      importMergeBtn.addEventListener("click", ()=>{
        if(!pendingImport) return;
        const ok = confirm("ä»Šã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã«ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ˜ç´°ã‚’è¿½åŠ ã™ã‚‹ã‚ˆã€‚ã‚ˆã‘ã‚Œã°OKã€‚");
        if(ok) applyImport("merge");
      });
    }
  }




  boot();
</script>
</body>
</html>
